library(RODBC)
library(ggplot2)
library(plyr)
library(gtable)
library(grid)
library(reshape2)

bigQueryLink <-"https://bigquery.cloud.google.com/dataset/fh-bigquery:reddit_comments"
begin <- "2017-01-01"
end <- "2017-03-01"

seattleWA_dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost\\SQLEXPRESS;database=SeattleWA_subreddit;trusted_connection=true')
other_dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost\\SQLEXPRESS;database=seattle_subreddit;trusted_connection=true')

query <- paste('select comment.*, post.domain, post.author as \'post_author\' 
, post.link_flair_text 
from comment
inner join post on replace(comment.link_id,\'t3_\',\'\') = post.id
                where comment.created_pacific <
\'',end ,'\'
and comment.created_pacific >=\'', begin,'\'', sep="")

commData <- sqlQuery(seattleWA_dbhandle, query)
other_commData <- sqlQuery(other_dbhandle, query)


cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```{r comments}
numComm <-NROW(commData)
cat("# of comments: ", numComm) 
gold <- sum(commData[,"gilded"])
cat("# gold set to comments:", gold)

commData$YearMonth <- format(as.Date(commData$created_pacific,"America/Los_Angeles"), "%Y-%m")
commCountPerMonth <- count(commData,c( "YearMonth"))

other_commData$YearMonth <- format(as.Date(other_commData$created_pacific,"America/Los_Angeles"), "%Y-%m")
other_commCountPerMonth <- count(other_commData,c( "YearMonth"))

plot_seattleWaCommCountPerMonth <- ggplot(data=commCountPerMonth, 
                     aes(x=YearMonth,y=freq, fill=cbPalette[1:1], width=.75)) +
  geom_bar(width=1,stat="identity") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_seattleCommCountPerMonth <- ggplot(data=other_commCountPerMonth, 
                     aes(x=YearMonth,y=freq, fill=cbPalette[2:2])) +
  geom_line(aes(group=1), size=2) +
  guides(fill=FALSE) +
  theme(panel.background = element_rect(fill = NA), 
        panel.grid = element_blank()) + 
  expand_limits(y=c(0))





f <- data.frame(YearMonth=commCountPerMonth$YearMonth, seattle=other_commCountPerMonth$freq, seattleWA=commCountPerMonth$freq)

#https://rpubs.com/MarkusLoew/226759

plot_seattleWaCommCountPerMonth <- ggplot(data=f, 
                     aes(x=YearMonth,y=seattleWA, fill=cbPalette[1:1], width=.75)) +
  geom_bar(width=1,stat="identity") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_line(aes(y=seattle*1.5, group=1), size=1.1) + 
  scale_y_continuous(sec.axis = sec_axis(~./1.5))


```{r comment count }
dual <- data.frame(YearMonth = c(commCountPerMonth$YearMonth, other_commCountPerMonth$YearMonth), count = c(commCountPerMonth$freq, other_commCountPerMonth$freq), sub=c(rep("seattleWA", nrow(commCountPerMonth)), rep("seattle", nrow(other_commCountPerMonth))),stringsAsFactors = FALSE)

ggplot(dual, aes(YearMonth, count)) + geom_bar(aes(fill = sub), 
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Comments", fill="SubReddit", title="Total Comments by Month")


```{r unique authors}
uniqueAuthorsYearMonth <- ddply(commData, ~YearMonth, summarise, c = length(unique(author)))
other_uniqueAuthorsYearMonth <- ddply(other_commData, ~YearMonth, summarise, c = length(unique(author)))

uniques <- data.frame(YearMonth = c(uniqueAuthorsYearMonth$YearMonth, other_uniqueAuthorsYearMonth$YearMonth), 
                      count = c(uniqueAuthorsYearMonth$c, other_uniqueAuthorsYearMonth$c),
                      sub=c(rep("SeattleWA", nrow(uniqueAuthorsYearMonth)), 
                            rep("seattle", nrow(other_uniqueAuthorsYearMonth))),
                      stringsAsFactors = FALSE)

ggplot(uniques, aes(YearMonth, count)) + geom_bar(aes(fill = sub), 
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Unique Comment Authors", fill="SubReddit", title="Total Unique Comment Authors by Month")



```{r ratio comment to unique authors}
commentRatio <- data.frame(YearMonth = dual[order(dual$sub, dual$YearMonth),"YearMonth"], 
           ratio = dual[order(dual$sub,dual$YearMonth), "count"]/uniques[order(uniques$sub, uniques$YearMonth),"count"],
           sub = dual[order(dual$sub, dual$YearMonth),"sub"])

ggplot(commentRatio, aes(YearMonth, ratio)) + geom_bar(aes(fill = sub), 
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Comments", fill="SubReddit", title="Ratio: Comments to Author")


#removed
```{r removed comments by mod}
removed <- ddply(commData[grep("^\\[removed\\]", commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c = length(YearMonth))

other_removed <- ddply(other_commData[grep("^\\[removed\\]", other_commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c = length(YearMonth))

removedData <- data.frame(YearMonth = c(removed$YearMonth, other_removed$YearMonth), 
                   count = c(removed$c, other_removed$c),
                   sub = c(rep("SeattleWA",nrow(removed)), rep("seattle", nrow(other_removed))))

ggplot(removedData, aes(YearMonth,count)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of comments removed by Mods", fill="SubReddit", title="Total Comments Removed by Mods by Month")



```{r comment gold by month}
goldByYearMonth <- ddply(commData, ~YearMonth,   summarize, s = sum(gilded))
other_goldByYearMonth <- ddply(other_commData, ~YearMonth,   summarize, s = sum(gilded))

gold <- data.frame(YearMonth = c(goldByYearMonth$YearMonth, other_goldByYearMonth$YearMonth), 
                   sum = c(goldByYearMonth$s, other_goldByYearMonth$s),
                   sub = c(rep("SeattleWA",nrow(goldByYearMonth)), rep("seattle", nrow(other_goldByYearMonth))))

ggplot(gold, aes(YearMonth, sum)) + geom_bar(aes(fill = sub), 
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Amount of Gold", fill="SubReddit", title="Total Comment Gold by Month")


```{r RainerRancor score by month}
RR <- ddply(commData[commData$author=="RainierRancor",], ~YearMonth,   summarize, s = sum(score), c=length(author))
other_RR <-ddply(other_commData[other_commData$author=="RainierRancor",], ~YearMonth,   summarize, s = sum(score), c=length(author))

rrdata <- data.frame(YearMonth = c(RR$YearMonth, other_RR$YearMonth),
                     count = c(RR$c, other_RR$c),
                     score = c(RR$s, other_RR$s),
                     sub = c(rep("SeattleWA", nrow(RR)),rep("seattle",nrow(other_RR))),
                    stringsAsFactors = FALSE)

ggplot(rrdata, aes(YearMonth,count)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Comments", fill="SubReddit", title="Total RainerRancor Comments by Month")

ggplot(rrdata, aes(YearMonth,score)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Score", fill="SubReddit", title="Total RainerRancor Comment Score by Month")

```{r nimby}
nimby <- ddply(commData[grep("NIMBies|NIMBY", commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c=length(YearMonth), authors=length(unique(author)))
other_nimby <- ddply(other_commData[grep("NIMBies|NIMBY", other_commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c=length(YearMonth), authors=length(unique(author)))

nimbyData <- data.frame(YearMonth=c(nimby$YearMonth,other_nimby$YearMonth),
                        count=c(nimby$c,other_nimby$c),
                        score=c(nimby$s,other_nimby$s),
                        uniq=c(nimby$authors, other_nimby$authors),
                        sub = c(rep("SeattleWA", nrow(nimby)),rep("seattle",nrow(other_nimby))))

ggplot(nimbyData, aes(YearMonth,count)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Comments", fill="SubReddit", title="Total Comments Refering to Nimby(s|ies) by Month")

```{r tacotime}
tacoTime <- ddply(commData[grep("\\btaco *time[s]?(nw)?\\b", commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c = length(YearMonth), authors=length(unique(author)))

other_tacoTime <- ddply(other_commData[grep("\\btaco *time[s]?(nw)?\\b", other_commData$body,ignore.case = TRUE),], ~YearMonth,   summarize, s = sum(score), c = length(YearMonth), authors=length(unique(author)))

tacoData <- data.frame(YearMonth = c(tacoTime$YearMonth, other_tacoTime$YearMonth), 
                   score = c(tacoTime$s, other_tacoTime$s),
                   count = c(tacoTime$c, other_tacoTime$c),
                   authors = c(tacoTime$authors, other_tacoTime$authors),
                   sub = c(rep("SeattleWA",nrow(tacoTime)), rep("seattle", nrow(other_tacoTime))))

ggplot(tacoData, aes(YearMonth,count)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Taco Time references", fill="SubReddit", title="Total Comments Refering to Taco Time by Month")

ggplot(tacoData, aes(YearMonth,authors)) + geom_bar(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Taco Time authors", fill="SubReddit", title="Total Comment Authors Refering to Taco Time by Month")






#Authors with most comments by year month?
authorCounts <- ddply(commData, ~YearMonth+author, summarise, c = length(author))

authorCounts[( (authorCounts$YearMonth<'2016-10' & t$c>400   ) | t$c>500 )& t$author!='[deleted]',]

ggplot(tacoData, aes(YearMonth,authors)) + geom_line(aes(fill = sub),
   width = 0.4, position = position_dodge(width=0.5), stat="identity") +  
   theme(legend.position="top") +
  labs(x="",y="Number of Taco Time authors", fill="SubReddit", title="Total Comment Authors Refering to Taco Time by Month")
