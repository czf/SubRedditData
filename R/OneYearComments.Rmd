library(RODBC)
library(ggplot2)
library(plyr)
library(gtable)
library(grid)

bigQueryLink <-"https://bigquery.cloud.google.com/dataset/fh-bigquery:reddit_comments"
begin <- "2017-01-01"
end <- "2017-03-01"

seattleWA_dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost\\SQLEXPRESS;database=SeattleWA_subreddit;trusted_connection=true')
seattle_dbhandle <- odbcDriverConnect('driver={SQL Server};server=localhost\\SQLEXPRESS;database=Seattle_subreddit;trusted_connection=true')

query <- paste('select comment.*, post.domain, post.author as \'post_author\' 
, post.link_flair_text 
from comment
inner join post on replace(comment.link_id,\'t3_\',\'\') = post.id
                where comment.created_pacific <
\'',end ,'\'
and comment.created_pacific >=\'', begin,'\'', sep="")

commData <- sqlQuery(seattleWA_dbhandle, query)
seattle_commData <- sqlQuery(seattle_dbhandle, query)


cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```{r comments}
numComm <-NROW(commData)
cat("# of comments: ", numComm) 
gold <- sum(commData[,"gilded"])
cat("# gold set to comments:", gold)

commData$YearMonth <- format(as.Date(commData$created_pacific,"America/Los_Angeles"), "%Y-%m")
commCountPerMonth <- count(commData,c( "YearMonth"))

seattle_commData$YearMonth <- format(as.Date(seattle_commData$created_pacific,"America/Los_Angeles"), "%Y-%m")
seattle_commCountPerMonth <- count(seattle_commData,c( "YearMonth"))

plot_seattleWaCommCountPerMonth <- ggplot(data=commCountPerMonth, 
                     aes(x=YearMonth,y=freq, fill=cbPalette[1:1], width=.75)) +
  geom_bar(width=1,stat="identity") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_seattleCommCountPerMonth <- ggplot(data=seattle_commCountPerMonth, 
                     aes(x=YearMonth,y=freq, fill=cbPalette[2:2])) +
  geom_line(aes(group=1), size=2) +
  guides(fill=FALSE) +
  theme(panel.background = element_rect(fill = NA), 
        panel.grid = element_blank()) + 
  expand_limits(y=c(0))





f <- data.frame(YearMonth=commCountPerMonth$YearMonth, seattle=seattle_commCountPerMonth$freq, seattleWA=commCountPerMonth$freq)

#https://rpubs.com/MarkusLoew/226759

plot_seattleWaCommCountPerMonth <- ggplot(data=f, 
                     aes(x=YearMonth,y=seattleWA, fill=cbPalette[1:1], width=.75)) +
  geom_bar(width=1,stat="identity") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_line(aes(y=seattle*1.5, group=1), size=1.1) + 
  scale_y_continuous(sec.axis = sec_axis(~./1.5))







#uniques
authorFrequencyYearMonth <- count(commData, c("YearMonth" , "author"))
uniqueAuthorsYearMonth <- ddply(authorFrequencyYearMonth, ~YearMonth,nrow)

uniqueAuthorsYearMonth <- ddply(temp, ~YearMonth, summarise, c = length(unique(author)))